<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>신바위 문제</title>

  <!-- PWA 연결 -->
  <link rel="manifest" href="/shinbawiproblems/manifest.json" />

  <!-- 상단/시스템 UI 색상: 검정 -->
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- 서비스워커 등록 -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/shinbawiproblems/sw.js").catch(()=>{});
    }
  </script>

  <!-- 공통 스타일 -->
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto,
                   Apple SD Gothic Neo, Malgun Gothic, Arial, sans-serif;
    }
    .wrap {
      max-width: 960px;
      margin: 40px auto;
      padding: 16px;
      display: grid;
      gap: 16px;
    }
    /* 버튼 공통 (앵커, 버튼 동일 적용) */
    .btn {
      display: block;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      padding: 18px 16px;
      border-radius: 12px;
      background: #fff;
      color: #000;
      border: 1px solid #e5e7eb;
      font-weight: 800;
      line-height: 1.2;
      text-decoration: none;
      cursor: pointer;
    }
    .hint { color: #cbd5e1; font-size: 14px; text-align: center; }

    /* ✅ 카톡 인앱 브라우저에서 button 기본 스타일 깨짐 방지 */
    button.btn {
      all: unset;
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 18px 16px;
      border-radius: 12px;
      background: #fff;
      color: #000;
      border: 1px solid #e5e7eb;
      font-weight: 800;
      text-align: center;
      line-height: 1.2;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }
    button.btn:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>
</head>
<body>

  <script>
    const DRIVE_URL   = "https://drive.google.com/drive/folders/1Iax6j8wGi6z6mV21craLi7TY0u9sW_3K";
    const LANDING_URL = "https://shinbw.github.io/shinbawiproblems/";

    // 앱(PWA)으로 실행되면 → 바로 연구소 드라이브로 이동
    const isStandalone =
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone;

    if (isStandalone) {
      location.replace(DRIVE_URL);
    }
  </script>

  <!-- 일반 브라우저에서 보이는 첫 화면 -->
  <section class="wrap">
    <!-- 위: 앱 설치 -->
    <button id="installBtn" class="btn" disabled style="cursor:not-allowed;">
      앱 설치
    </button>

    <!-- 아래: 신바위 연구소 구글드라이브 -->
    <a class="btn" href="https://drive.google.com/drive/folders/1Iax6j8wGi6z6mV21craLi7TY0u9sW_3K">
      신바위 연구소 입장
    </a>

    <div id="installMsg" class="hint"></div>
  </section>

  <script>
    // 앱 설치 로직
    const installBtn = document.getElementById("installBtn");
    const installMsg = document.getElementById("installMsg");
    let deferredPrompt = null;

    const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    if (isiOS && isSafari) {
      installBtn.disabled = true;
      installBtn.style.cursor = "not-allowed";
      installMsg.innerHTML = "iPhone/Safari는 <b>공유(⬆️) → 홈 화면에 추가</b>로 설치하세요.";
    }

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.disabled = false;
      installBtn.style.cursor = "pointer";
      installMsg.textContent = "앱 설치가 가능합니다. 버튼을 눌러 설치하세요.";
    });

    installBtn.addEventListener("click", async () => {
      if (!deferredPrompt) {
        installMsg.textContent = "아직 설치 준비 중입니다. 새로고침 후 다시 시도하세요.";
        return;
      }
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      installMsg.textContent = (outcome === "accepted") ? "설치를 진행합니다…" : "설치를 취소했습니다.";
      deferredPrompt = null;
      installBtn.disabled = true;
      installBtn.style.cursor = "not-allowed";
    });

    window.addEventListener("appinstalled", () => {
      installMsg.textContent = "설치 완료! 앱 실행 시 자동으로 연구소로 이동합니다.";
    });
  </script>

  <!-- 카톡 인앱 브라우저 감지 오버레이 -->
  <script>
  (function () {
    const isKakao = /KAKAOTALK/i.test(navigator.userAgent);
    if (!isKakao) return;

    const isAndroid = /Android/i.test(navigator.userAgent);
    const isIOS     = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    const chromeIntent =
      "intent://" + LANDING_URL.replace(/^https?:\/\//, "") +
      "#Intent;scheme=https;package=com.android.chrome;" +
      "S.browser_fallback_url=" +
      encodeURIComponent("https://play.google.com/store/apps/details?id=com.android.chrome") +
      ";end";

    const $wrap = document.createElement("div");
    $wrap.style.cssText = `
      position: fixed; inset: 0; z-index: 9999;
      background: #000; display:flex; align-items:center; justify-content:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Malgun Gothic, Arial, sans-serif;
    `;

    const $sheet = document.createElement("div");
    $sheet.style.cssText = `
      width:min(560px, 92vw); background:#111; color:#f1f5f9;
      border-radius:20px; padding:28px; box-shadow:0 6px 32px rgba(0,0,0,.7);
      text-align:center;
    `;

    const tip = isAndroid
      ? "오른쪽 <b>하단</b> 점 3개 → <b>다른 브라우저로 열기</b> → <b>Chrome</b>"
      : "공유(⬆️) → <b>Safari에서 열기</b> 또는 <b>홈 화면에 추가</b>";

    $sheet.innerHTML = `
      <h2 style="margin:0 0 16px;font-size:22px;font-weight:800;color:#fff;">카카오톡 인앱 브라우저 감지됨</h2>
      <p style="margin:0 0 24px;line-height:1.6;color:#cbd5e1;font-size:15px;">
        원활한 사용을 위해 <b style="color:#38bdf8">${isAndroid ? "Chrome" : "Safari"}</b>에서 열어주세요.<br>
        <span style="font-size:14px;color:#94a3b8">${tip}</span>
      </p>

      <div style="display:grid; gap:14px;">
        ${isAndroid ? `
          <a href="${chromeIntent}"
             style="display:block;padding:14px 0;border-radius:12px;
                    background:#fff;color:#000;font-weight:800;text-decoration:none;">
            Chrome으로 열기
          </a>
        ` : `
          <button id="copyLinkBtn"
                  style="padding:14px 0;border-radius:12px;border:1px solid #333;
                         background:#fff;color:#000;font-weight:800;cursor:pointer;">
            링크 복사 → Safari 붙여넣기
          </button>
        `}
        <a href="${LANDING_URL}"
           style="display:block;padding:12px 0;border-radius:12px;
                  border:1px solid #333;background:#fff;color:#000;font-weight:800;text-decoration:none;">
          이 창에서 계속 (인앱)
        </a>
      </div>

      <p style="margin-top:20px;font-size:12px;color:#64748b;">
        설치(PWA) 후 앱 실행 시 곧바로 신바위 연구소로 이동합니다.
      </p>
    `;

    $wrap.appendChild($sheet);
    document.body.appendChild($wrap);

    if (isIOS) {
      const copyBtn = $sheet.querySelector("#copyLinkBtn");
      copyBtn?.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(LANDING_URL);
          copyBtn.textContent = "✅ 복사됨! Safari에 붙여넣으세요";
          copyBtn.style.background = "#e5e7eb";
        } catch {
          alert("복사 실패: 주소창을 길게 눌러 직접 복사해주세요.");
        }
      });
    }
  })();
  </script>

</body>
</html>
